name: CI

on:
  push:
    branches:
      - master
      - feature/**
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Run tests via Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are operating inside a GitHub Actions CI job with Docker Compose available and the repository checked out at the workspace root.

            Objective:
            1. Set `DOCKER_CONFIG=/tmp/docker-config` and ensure `"$DOCKER_CONFIG/buildx"` exists so Docker can create build state.
            2. Ensure the current user can talk to Docker by running `sudo usermod -aG docker "$USER"` and then reloading membership via `newgrp docker`.
            3. Build the Docker images needed for the test runs: `docker compose build`.
            4. Execute the auth service tests by running `docker compose run --rm auth npm test`.
            5. Execute the server service tests by running `docker compose run --rm mcp sh -c "npm install && npm test"`.
            6. After tests finish (regardless of outcome) call `docker compose down --remove-orphans` to clean up containers.
            7. If any command returns a non-zero exit code, stop immediately and report the failure details.
            8. When both test commands succeed, produce a concise success summary that mentions each command.

            Constraints:
            - Execute commands using shell syntax in the repository root.
            - Treat any non-zero exit status as a failure of this CI job.
            - Do not modify repository files or perform additional installs beyond the commands listed.

            Provide the results in the final message.
