name: CI

on:
  push:
    branches:
      - master
      - feature/**
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      NODE_VERSION: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            server/package-lock.json

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Install auth dependencies
        working-directory: auth
        run: npm install

      - name: Run tests via Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are operating inside a GitHub Actions CI job. Dependencies for each package have already been installed.

            Objective:
            1. Run `npm test` inside the `server` directory.
            2. Run `npm test` inside the `auth` directory.
            3. If either command fails or exits non-zero, stop immediately and return a clear failure message.
            4. When both commands succeed, produce a concise summary indicating success.

            Constraints:
            - Execute commands using shell syntax.
            - Treat any non-zero exit code as a failure of this CI job.
            - Do not attempt to reinstall dependencies or modify unrelated files.

            Provide the results in the final message.
